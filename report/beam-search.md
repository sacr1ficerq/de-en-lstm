# Beam search

*На борьбу с этим методом ушло приблизительно столько же часов(25-30), сколько на все эксперименты с архитектурой модели, при этом он по-прежнему генерирует каким-то образом переводы **значительно** уступающие greedy search (beam_search(k=1)) в BLEU4. Во многом благодаря этой несправеделивости двигались мои эксперименты, как у игромана, который пытается отыграть проигранные деньги в рулетке.*

*Повышение label smoothing в попытке сгладить вероятности для генерации лучших последовательностей, погружение в BLEU, добавление \<SUB\> и \<NUM\>, большинство дебаг инструментов были добавлены в надежде обогнать greedy search, который интуитивно никак не должен побеждать метод, который содержит в себе его пространство ответов.*

## Особенности реализации

### Параметры Beam Search

- **beam_width**: Количество бимов
- **max_len**: Максимальная длина выходных последовательностей
- **remove_unk**: Занулять или нет логит с \<UNK\>
- **border**: Порог для отсечения токенов с низкой вероятностью
- **verbose**: Уровень детализации вывода (0 - минимальный, 1 - средний, 2 - максимальный)

### Оптимизации и штрафы

- **Штраф за повторение**: Уменьшение вероятности повторяющихся токенов. Вероятность уменьшаяется в два раза за каждое повторение.
- **Штраф за длину**: При выборе финального бима штрафуем экспоненциалоьно за отклонение от предполагаемой длины.
- **Регулировка длины**: После предполагаемой длины вероятность токена \<EOS\> начинает искусственно расти.

### Возвращаемые значения

- **trg_seq**: Лучшая последовательность токенов
- **trg_seq_scores**: Логарифмы вероятностей для каждого токена в последовательности

### Пример генерации с `verbose=1`
```
k: 5	B: 1	max_len: 17
beam tokens:
<BOS>|und  |das  |müssen|wir  |umsetz|,    |bevor|wir  |es   |tun  |.    |<EOS>
index in batch: 0
beam-probabilities: 0.0018|0.0005|0.0004|0.0003|2.0558

	beam probability: 0.18
<BOS>|and  |that |'s   |going|to   |do   |that |before|we   |do   |it   |.    |<EOS>|<PAD>|<PAD>|<PAD>|<PAD>
100.0|74.08|997.42|54.88|11.08|49.66|4.5  |10.03|3.69 |9.07 |1.11 |5.5  |0.74 |4.08 |0.74 |1.66 |0.27 |0.67 
	beam probability: 0.05
<BOS>|and  |that |'s   |going|to   |do   |it   |before|we   |do   |it   |.    |<EOS>|<PAD>|<PAD>|<PAD>|<PAD>
100.0|74.08|997.42|54.88|11.08|49.66|4.5  |0.1  |149.18|0.09 |49.66|0.02 |36.79|0.02 |36.79|0.01 |14.96|0.0  
	beam probability: 0.05
<BOS>|and  |that |'s   |going|to   |do   |this |before|we   |do   |it   |.    |<EOS>|<PAD>|<PAD>|<PAD>|<PAD>
100.0|74.08|997.42|54.88|11.08|49.66|4.5  |0.3  |27.25|0.25 |7.43 |0.14 |6.72 |0.11 |6.72 |0.04 |2.73 |0.02 
	beam probability: 0.03
<BOS>|and  |that |'s   |going|to   |do   |that |before|we   |do   |this |.    |<EOS>|<PAD>|<PAD>|<PAD>|<PAD>
100.0|74.08|997.42|54.88|11.08|49.66|4.5  |10.03|3.69 |9.07 |1.11 |0.09 |6.72 |0.07 |6.72 |0.03 |2.73 |0.01 
	beam probability: 0.00
<BOS>|and  |that |'s   |going|to   |do   |that |before|we   |do   |it   |,    |before|we   |do   |.    |<EOS>
100.0|74.08|997.42|54.88|11.08|49.66|4.5  |10.03|3.69 |9.07 |1.11 |5.5  |90.48|0.0  |20.19|0.0  |5.5  |0.0  

result:
<BOS>|and  |that |'s   |going|to   |do   |that |before|we   |do   |it   |.    |<EOS>|<PAD>|<PAD>|<PAD>|<PAD>
100.0|74.08|997.42|54.88|11.08|49.66|4.5  |10.03|3.69 |9.07 |1.11 |5.5  |0.74 |4.08 |0.74 |1.66 |0.27 |0.67 
src:		 und das müssen wir umsetzen , bevor wir es tun .
trg:		 and we need to establish that before we do so .
pred:		 and that 's what we need to do before we do it .
pred-beam:	 and that 's going to do that before we do it .
bleu:		21.40
bleu beam:	24.38
```

## Пример с тем, как работает beam-search [здесь](beam-search.txt)